/*
 * multifile-upload v1.2 (https://www.impactmedianc.com/)
 * Copyright Impact Media 2016 Drew Denstedt
 */

var MultiFile=function(e){this.debug=!1,this.form_id=e,this.upload_url="",this.redirect_url="",this.megabyte=1048576,this.max_upload_size=50,this.max_upload_bytes=this.megabyte*this.max_upload_size,this.files=[],this.form=document.getElementById(e),null!==this.form?this.upload_url=this.form.action:this.errorMessage("form"),this.errorModal(),this.inputListener(),this.outputListener(),this.formListener()};MultiFile.prototype.setDebug=function(e){this.debug=e},MultiFile.prototype.setUploadUrl=function(e){this.upload_url=e},MultiFile.prototype.setRedirectUrl=function(e){this.redirect_url=e},MultiFile.prototype.setInput=function(e){var t=document.getElementById(e);null!==t?this.files[e]=[]:this.errorMessage("input")},MultiFile.prototype.compareFiles=function(e){if(this.files[e.id].length>0){if(e.files.length>0)for(var t in e.files){var i=!0;for(var a in this.files[e.id])e.files[t]!=this.files[e.id][a]&&"length"!=t||(i=!1);if(i){var l=this.files[e.id].length;this.files[e.id][l]=e.files[t],this.files[e.id].length=l+1}}}else if(e.files.length>0)for(var t in e.files)this.files[e.id][t]=e.files[t];this.updateOutput(e)},MultiFile.prototype.updateOutput=function(e){var t=document.getElementById(e.id+"-output");if(null!==t&&t.parentNode.removeChild(t),e.parentNode.parentNode.getElementsByTagName("output")[0].textContent="",this.files[e.id].length>0){for(var i=document.createDocumentFragment(),a=0;a<this.files[e.id].length;a++){var l=document.createElement("div");l.classList.add("row","multifile-output");var n=document.createElement("span");n.className="col-xs-12",n.textContent=this.files[e.id][a].name;var o=document.createElement("span");o.classList.add("glyphicon","glyphicon-remove","multifile-remove"),o.dataset.multifile=a,o.dataset.multifile_id=e.id,n.appendChild(o),l.appendChild(n),i.appendChild(l)}e.parentNode.parentNode.getElementsByTagName("output")[0].appendChild(i)}else e.parentNode.parentNode.getElementsByTagName("output")[0].textContent="No Files Chosen"},MultiFile.prototype.errorModal=function(){var e=document.createDocumentFragment(),t=document.createElement("div");t.id="multifile-error-modal",t.classList.add("modal","fade"),t.tabIndex=-1,t.role="dialog";var i=document.createElement("div");i.className="modal-dialog",i.role="document";var a=document.createElement("div");a.className="modal-content";var l=document.createElement("div");l.className="modal-header";var n=document.createElement("h4");n.classList.add("modal-title","text-danger"),n.textContent="Error";var o=document.createElement("div");o.className="modal-body";var r=document.createElement("p");r.textContent="Total attached files are greater than the max file size. Please reduce attached file size to under "+this.max_upload_size+"mb";var s=document.createElement("div");s.className="modal-footer";var d=document.createElement("button");d.type="button",d.classList.add("btn","btn-danger"),d.dataset.dismiss="modal",d.textContent="Close",l.appendChild(n),o.appendChild(r),s.appendChild(d),a.appendChild(l),a.appendChild(o),a.appendChild(s),i.appendChild(a),t.appendChild(i),e.appendChild(t),document.body.appendChild(e)},MultiFile.prototype.inputListener=function(){var e=this;document.addEventListener("change",function(t){t.target&&t.target.classList.contains("multifile")&&e.compareFiles(document.getElementById(t.target.id))})},MultiFile.prototype.outputListener=function(){var e=this;document.addEventListener("mouseup",function(t){t.target&&t.target.classList.contains("multifile-remove")&&(e.files[t.target.dataset.multifile_id].splice([Number(t.target.dataset.multifile)],1),e.updateOutput(document.getElementById(t.target.dataset.multifile_id)))})},MultiFile.prototype.formListener=function(){var e=this;this.form.addEventListener("submit",function(t){t.preventDefault();var i=new FormData,a=0;for(var l in e.files)for(var n=0;n<e.files[l].length;n++)i.append(l+"[]",e.files[l][n]),a+=e.files[l][n].size;if(a<e.max_upload_bytes){var o=$("#"+e.form_id).serializeArray();$.each(o,function(e,t){i.append(t.name,t.value)}),$.ajax({url:e.upload_url,data:i,processData:!1,contentType:!1,type:"POST",success:function(t){e.debug?console.log(t):window.location.replace(e.redirect_url)},error:function(e,t){var i="";i=0===e.status?"Not connect.\n Verify Network.":404==e.status?"Requested page not found. [404]":500==e.status?"Internal Server Error [500].":"parsererror"===t?"Requested JSON parse failed.":"timeout"===t?"Time out error.":"abort"===t?"Ajax request aborted.":"Uncaught Error.\n"+e.responseText,console.log(i)}})}else $("#multifile-error-modal").modal("show")})},MultiFile.prototype.errorMessage=function(e){switch(e){case"form":console.log("Invalid Form ID");break;case"input":console.log("Invalid Input ID");break;default:console.log("Unknown Error :/")}};